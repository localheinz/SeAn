{'$D-,A-,I-,L-,E-,O-,R-,S-'}
Program SearchExeFiles;
Uses Crt,Dos,SeAnHelp;
Type ExeHeaderType   = Record
                        Byte4Dh           : Byte; { 4D-hex                                       }
                        Byte5Ah           : Byte; { 55-hex                                       }
                        BytesLastPage     : Word; { Number of Bytes on last Page                 }
                        TotalPages        : Word; { Number of Pages in EXE-File (Page=512 Bytes  }
                        RelozEntries      : Word; { Number of Entires in Relozierungs-Tabelle    }
                        HeaderSize        : Word; { Size of Header as a factor of 16             }
                        MinSizeOfPages    : Word; { Number of Pages required free upon program   }
                        MaxSizeOfPages    : Word; { Number of Pages required free upon program   }
                        SSRegister        : Word;
                        SPRegister        : Word;
                        CodeWord          : Word; { Negative Sum of all Bytes in EXE-File        }
                        IPRegister        : Word;
                        CSRegister        : Word;
                        RelOffSet         : Word; { OffSet from Relozierungs-Tabell to EXE-Begin }
                        OverLay           : Word; { Generated by MS-Link                         }
                       End;
Var ExeFiles       : Integer;
    WExeFiles      : Integer;
    TESize         : LongInt; { Total size of all exe-files     }
    TWSize         : LongInt; { Total size of invalid exe-files }
    Dir            : DirStr;
    TSize          : LongInt;
    SSize          : String;
    S              : String;
    Mega           : Integer;
    Kilo           : Integer;
    Bytes          : Integer;
    FirstTimerHigh : Word;
    FirstTimerLow  : Word;
    R              : Registers;
    Time           : LongInt;

Procedure FindFiles(Dir : DirStr);
Var S    : SearchRec;
    ExeF : File Of ExeHeaderType;
    ExeD : ExeHeaderType;
    C    : Char;
Begin
 FindFirst(Dir+'\*.Exe',AnyFile,S);
 While (DosError=0) Do
 Begin;
  If (S.Attr<>$10) Then
  Begin;
   Inc(ExeFiles);
   {$I-}
   Assign(ExeF,S.Name);
   ReSet(ExeF);
   Read(ExeF,ExeD);
   Close(ExeF);
   {$I+}
   Inc(TESize,S.Size);
   If ((ExeD.TotalPages-1)*512+ExeD.BytesLastPage)<>S.Size Then
   Begin;
    Inc(WExeFiles);
    Inc(TWSize,S.Size);
    WriteLn(Dir+'\'+S.Name,' differs by ',BigSize(Abs(S.Size-(ExeD.TotalPages-1)*512-ExeD.BytesLastPage)),' Bytes.');
   End;
  End;
  FindNext(S);
 End;
 FindFirst(Dir+'\*.*',Directory,S);
 While (DosError=0) Do
 Begin;
  If (S.Attr=$10) And (S.Name[1]<>'.') Then
  Begin;
   ChDir(Dir+'\'+S.Name);
   FindFiles(Dir+'\'+S.Name);
  End;
  FindNext(S);
 End;
End;


 Begin
  ExeFiles :=0;
  WExeFiles:=0;
  TESize   :=0;
  TWSize   :=0;
  GetDir(0,Dir);
  WriteLn('V.Pas written by Andreas M”ller for SeAn (11/27/94).');
  WriteLn('Startup Directory : ',Dir);
  Writeln('Checking all exe-files for viral actions.');
  R.Ah:=$00;
  Intr($1A,R);
  FirstTimerHigh:=R.Cx;
  FirstTimerLow:=R.Dx;
  R.Ah:=$01;
  R.Cx:=$00;
  R.Dx:=$00;
  Intr($1A,R);
  FindFiles(Dir[1]+':');
  R.Ah:=$00;
  Intr($1A,R);
  Time:=R.Cx*2*2*2*2*2*2*2*2*2*2*2*2*2*2*2*2+R.Dx;
  R.Ah:=$00;
  Intr($1A,R);
  R.Ah:=$01;
  R.Cx:=R.Cx+FirstTimerHigh;
  R.Dx:=R.Dx+FirstTimerLow;
  Intr($1A,R);
  WriteLn('Found ',BigSize(ExeFiles),' files with a total size of ',BigSize(TESize),' Bytes.');
  WriteLn('Found ',BigSize(WExeFiles),' which could have been changed totaling ',BigSize(TWSize),' Bytes');
  WriteLn('Elapsed time is ',(Time/18.2):5:2,'s.');
  WriteLn;
  ChDir(Dir);
 End.
